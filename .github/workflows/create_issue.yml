name: Create Issue from Data Submission

on:
  push:
    paths:
      - "data_submissions/*.json" # 监听 data_submissions 文件夹中的新文件

jobs:
  create_issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create Issue for New Data Submission
        env:
          SECRET_TOKEN: ${{ secrets.SECRET_TOKEN }} # 使用添加的 Secret
        run: |
          for file in $(git diff --name-only --diff-filter=A HEAD^ HEAD); do
            if [[ $file == data_submissions/*.json ]]; then
              data=$(cat "$file")
              title=$(echo "$data" | jq -r .name)
              body=$(echo "$data" | jq -r .description)
              tags=$(echo "$data" | jq -r .tags)
              
              curl -X POST -H "Authorization: Bearer $SECRET_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/${{ github.repository }}/issues \
                -d "{\"title\": \"New Data Submission: $title\", \"body\": \"**Description**: $body\n**Tags**: $tags\"}"
            fi
          done
